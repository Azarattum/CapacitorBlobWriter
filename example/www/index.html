<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <title>Awesome Capacitor App</title>
  <meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="format-detection" content="telephone=no">
  <meta name="msapplication-tap-highlight" content="no">

  <script type="module" src="https://unpkg.com/@ionic/pwa-elements@latest/dist/ionicpwaelements/ionicpwaelements.esm.js"></script>
  <script nomodule src="https://unpkg.com/@ionic/pwa-elements@latest/dist/ionicpwaelements/ionicpwaelements.js"></script>

  <link rel="icon" type="image/x-icon" href="assets/icon/favicon.ico">
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="css/style.css">
  <meta name="theme-color" content="#31d53d">

  <!-- un-comment this code to enable service worker
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log('service worker installed'))
        .catch(err => console.log('Error', err));
    }
  </script>-->
</head>
<body>
  <capacitor-welcome></capacitor-welcome>

  <!--
    This simple example uses Capacitor Core as a bundled file.
    For large apps, we recommend using a bundler/module loader such as
    rollup or webpack and importing Capacitor using ES2015 imports.
  -->
  <script src="capacitor.js"></script>

  <script src="js/capacitor-welcome.js"></script>

  <script>
    const port = 8080;

    const { Plugins, FilesystemDirectory, Capacitor } = window.capacitorExports
    const { Filesystem } = Plugins

    const output = document.createElement('pre')
    document.body.innerHTML = ''
    document.body.appendChild(output)

    function log (msg) {
      output.innerHTML += `${msg}\n`
    }

    async function compareBlobs(...blobs) {
      const buffers = await Promise.all(
        blobs.map(
          // read blobs as ArrayBuffers
          blob => new Response(blob).arrayBuffer()
        )
      )

      const views = buffers.map(buffer => new DataView(buffer))

      views.reduce((a, b) => {
        if (a.byteLength !== b.byteLength) {
          throw new Error('buffer lengths differ')
        }

        for (let i = 0; i < a.byteLength; i++) {
          if (a.getInt8(i) !== b.getInt8(i)) {
            throw new Error('buffers differ')
          }
        }

        return b
      })
    }

    // make a blob of random binary data
    function makeBlob(byteLength) {
      const buffer = new ArrayBuffer(byteLength)
      const view = new DataView(buffer)
      let position = 0

      while(position < buffer.byteLength) {
        const val = Math.floor(256 * Math.random())
        view.setInt8(position, val)
        position += 1
      }

      return new Blob([buffer], { type: 'application/octet-stream' })
    }

    async function testWrite({
      path = `/${Math.random()}.bin`,
      blob = makeBlob(10),
      directory = FilesystemDirectory.Data,
    }) {
      const { uri } = await Filesystem.getUri({ path, directory })

      const absolutePath = uri.replace('file://', '')
      const url = `http://localhost:${port}${absolutePath}`

      const start = Date.now()
      const put = await fetch(url, {method: 'put', body: blob })
      log(`wrote ${blob.size} bytes in ${Date.now() - start}ms`)

      if (put.status !== 204) {
        throw new Error(`bad PUT status`)
      }

      const fileURL = Capacitor.convertFileSrc(uri)
      const fileResponse = await fetch(fileURL)

      const fileBlob = await fileResponse.blob()

      await compareBlobs(blob, fileBlob)
    }

    async function run() {
      // non-existant file
      const now = Date.now()
      await testWrite({ path: `/${now}.txt` })

      // overwrite file
      await testWrite({ path: `/${now}.txt` })

      // edge cases with chunk sizes when writing to disk
      const chunkSize = 1024
      await testWrite({ blob: makeBlob(chunkSize) })
      await testWrite({ blob: makeBlob(chunkSize - 1) })
      await testWrite({ blob: makeBlob(chunkSize + 1) })

      // alternate directory
      await testWrite({ directory: FilesystemDirectory.Cache })

      // write multiple files concurrently
      await Promise.all([
        testWrite({}),
        testWrite({}),
        testWrite({}),
      ])

      // write same file concurrently
      try {
        await Promise.all([
          testWrite({ path: '/concurrent.bin' }),
          testWrite({ path: '/concurrent.bin' }),
        ])
      } catch (err) {
        if (err.message !== 'buffers differ') {
          throw err
        }
      }

      // write large file
      await testWrite({ blob: makeBlob(20 * 1024 * 1024) })

      log('tests passed!')
    }

    run().catch(err => {
      console.error(err)
      log(err.message)
    })
  </script>
</body>
</html>

